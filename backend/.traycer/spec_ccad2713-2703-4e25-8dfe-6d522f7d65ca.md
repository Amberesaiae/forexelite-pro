# Schema Migration Spec ccad2713-2703-4e25-8dfe-6d522f7d65ca

## Addition 2b — Updated job_type CHECK constraint

```sql
ALTER TABLE public.jobs
DROP CONSTRAINT jobs_job_type_check;

ALTER TABLE public.jobs
ADD CONSTRAINT jobs_job_type_check
CHECK (job_type IN ('compile', 'deploy', 'run', 'stop', 'test', 'trade', 'get_positions', 'get_account', 'get_candles', 'close_position'));
```

## Addition 6 — claim_next_job PostgreSQL function

```sql
CREATE OR REPLACE FUNCTION public.claim_next_job(p_agent_id UUID)
RETURNS SETOF public.jobs
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    claimed_job public.jobs;
BEGIN
    UPDATE public.jobs
    SET status = 'running',
        agent_id = p_agent_id,
        claimed_at = NOW()
    WHERE id = (
        SELECT id
        FROM public.jobs
        WHERE status = 'pending'
          AND (agent_id IS NULL OR agent_id = p_agent_id)
        ORDER BY created_at ASC
        FOR UPDATE SKIP LOCKED
        LIMIT 1
    )
    RETURNING * INTO claimed_job;

    IF FOUND THEN
        RETURN NEXT claimed_job;
    END IF;
END;
$$;

COMMENT ON FUNCTION public.claim_next_job IS 'Atomically claim the next pending job for an agent using FOR UPDATE SKIP LOCKED to prevent race conditions';

GRANT EXECUTE ON FUNCTION public.claim_next_job TO service_role;
```
